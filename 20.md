NIP-20
======


Command Results
---------------

`draft` `optional` `author:jb55` `author:fernandolguevara`

When submitting events to relays, clients currently have no way to know if an event was successfully committed to the database. This NIP introduces the concept of command results which are like NOTICE's except provide more information about if an event was accepted or rejected.

A command result is a JSON object with the following structure that is returned when an event is successfully saved to the database or rejected:

```json
accepted:
["OK", <event_id>, <message>, ...]
rejected:
["ERR", <event_id>, <error_code>, <detail>, ...]
````

Relays MUST return `OK` when the event is a duplicate and has already been saved. The `message` SHOULD start with `duplicate:` in this case.

Relays MUST return `ERR` when the event was rejected and not saved.

The `<error_code>` should be a non empty string.

The `<detail>` may provide additional information as to why the command succeeded or failed.

## ERROR

The `error_code` should be `BLOCKED` and `detail` may contain some additional if the pubkey or network address has been blocked, banned, or is not on a whitelist.

```json
// example
["ERR", <event_id>, "BLOCKED", { 
    'reason': 'your pubkey has been deactivated, want to get in touch? contact@relay.com' 
}, ...]
```

The `error_code` should be `INVALID` and `detail` should contain failure information if the event is invalid or doesn't meet some specific criteria (created_at is too far off, id is wrong, signature is wrong, etc)

```json
// example
["ERR", <event_id>, "INVALID", { 
    'reason': 'invalid' 
    'invalid-fields': { 
        'created_at': 'out-of-range',
        'id': 'invalid',
        'signature':'invalid'
    } 
}, ...]
```

The `error_code` should be `POW`. if the event doesn't meet some proof-of-work difficulty. The client MAY consult the relay metadata at this point to retrieve the required posting difficulty.

```json
// example
["ERR", <event_id>, "POW", { 
    'reason': 'difficulty-not-reached',
    'difficulty': x, 
    'server_difficulty': x, 
}, ...]
```

The `error_code` should be `RATE-LIMITED` and `detail` SHOULD start with `rate-limited:` if the event was rejected due to rate limiting techniques.

```json
// example
["ERR", <event_id>, "RATE-LIMITED", { 
    'reason': 'rate-limited',
    'limit': x, 
    'renewed_on': <unixdate>, 
}, ...]
```

The `error_code` should be `UNKNOWN`, if the event failed due to an unknown server issue.

```json
// example
["ERR", <event_id>, "UNKNOWN", { 
    'reason': '...',
}, ...]
```

Ephemeral events are not acknowledged with OK responses, unless there is a failure.

If the event or `EVENT` command is malformed and could not be parsed, a NOTICE message SHOULD be used instead of a command result. This NIP only applies to non-malformed EVENT commands.


Examples
--------

Event successfully written to the database:

```json
["OK", "b1a649ebe8b435ec71d3784793f3bbf4b93e64e17568a741aecd4c7ddeafce30", true, ""]
````

Event successfully written to the database because of a reason:

```json
["OK", "b1a649ebe8b435ec71d3784793f3bbf4b93e64e17568a741aecd4c7ddeafce30", true, "pow: difficulty 25>=24"]
```

Event blocked due to ip filter

```json
// example
["ERR", "b1a649ebe8...", "BLOCKED", { 
    'reason': 'tor exit nodes not allowed' 
}, ...]

// backwards compatibility if it's needed
["OK", "b1a649ebe8...", false, "blocked: tor exit nodes not allowed"]
```

Event blocked due to pubkey ban

```json
// example
["ERR", "b1a649ebe8...", "BLOCKED", { 
    'reason': 'you are banned from posting here' 
}, ...]

// backwards compatibility if it's needed
["OK", "b1a649ebe8...", false, "blocked: you are banned from posting here"]
```

Event blocked, pubkey not registered
```json
// example
["ERR", "b1a649ebe8...", "BLOCKED", { 
    'reason': 'please register your pubkey at https://my-expensive-relay.example.com' 
}, ...]

// backwards compatibility if it's needed
["OK", "b1a649ebe8...", false, "blocked: please register your pubkey at https://my-expensive-relay.example.com"]
```

Event rejected, rate limited

```json
// example
["ERR", "b1a649ebe8...", "RATE-LIMITED", { 
    'reason': 'rate-limited',
    'limit': 100, 
    'renewed_on': 611636400, 
}, ...]
````

Event rejected, `created_at` too far off

    ["OK", "b1a649ebe8...", false, "invalid: event creation date is too far off from the current time. Is your system clock in sync?"]

Event rejected, insufficient proof-of-work difficulty

```json
// example
["ERR", "b1a649ebe8...", "POW", { 
    'reason': 'difficulty-not-reached',
    'difficulty': 26, 
    'server_difficulty': 30, 
}, ...]
```

Event failed to save, 

```json
// example
["ERR", "b1a649ebe8...", "SERVER_ERROR", { 
    'reason': 'could not connect to the database',
}, ...]
```


Client Handling
---------------

TODO: refrase


`error_code` are meant for humans, with `reason:` prefixes so that clients can be slightly more intelligent with what to do with them. For example, with a `rate-limited:` reason the client may not show anything and simply try again with a longer timeout.

For the `pow:` prefix it may query relay metadata to get the updated difficulty requirement and try again in the background.

For the `invalid:` and `blocked`: prefix the client may wish to show these as styled error popups.

The prefixes include a colon so that the message can be cleanly separated from the prefix by taking everything after `:` and trimming it.


Future Extensions
-----------------

This proposal SHOULD be extended to support further commands in the future, such as REQ and AUTH. They are left out of this initial version to keep things simpler.
